# Chalan System - Visual Reference & Architecture

## ğŸ—ï¸ System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CHALAN MANAGEMENT SYSTEM                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              INCOMING REQUEST
                                    â”‚
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   URL ROUTER                â”‚
                    â”‚  /api/chalans/             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ChalanViewSet              â”‚
                    â”‚  (CRUD Operations)          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚                      â”‚
        â–¼                      â–¼                      â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ CREATE     â”‚      â”‚ UPDATE       â”‚      â”‚ CUSTOM ENDPOINTS â”‚
  â”‚ permission â”‚      â”‚ permission   â”‚      â”‚ mark_as_paid     â”‚
  â”‚ checks     â”‚      â”‚ checks       â”‚      â”‚ update_fees â­   â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ cancel           â”‚
       â”‚                     â”‚              â”‚ statistics       â”‚
       â–¼                     â–¼              â”‚ history          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ CanManageChalanFees (if fees)  â”‚              â”‚
    â”‚ CanEditChalan (if other fields)â”‚              â–¼
    â”‚ CanViewChalan (for retrieve)   â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ Permissions  â”‚
             â”‚                                 â”‚ Verified     â”‚
             â–¼                                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
    â”‚ SERIALIZER       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ Validation       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ DATABASE         â”‚
    â”‚                  â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ Chalan       â”‚ â”‚
    â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
    â”‚ â”‚ chalan_numberâ”‚ â”‚
    â”‚ â”‚ owner_cnic   â”‚ â”‚
    â”‚ â”‚ car_number   â”‚ â”‚
    â”‚ â”‚ fees_amount  â”‚ â”‚
    â”‚ â”‚ status       â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ ChalanHistoryâ”‚ â”‚
    â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
    â”‚ â”‚ action       â”‚ â”‚
    â”‚ â”‚ changes      â”‚ â”‚
    â”‚ â”‚ performed_by â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ RESPONSE         â”‚
    â”‚ 200 OK / 403 etc â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Permission Flow for Fee Management

```
        API Request to update fees
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ViewSet.get_list()  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Is this fees update? âš ï¸      â”‚
        â”‚ (check request data)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€?â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         NO      â”‚     YES   â”‚
                 â”‚           â–¼
                 â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚    â”‚ CanManageChalanFees?   â”‚
                 â”‚    â”‚ - User authenticated?  â”‚
                 â”‚    â”‚ - Is admin/staff?    â­â”‚
                 â”‚    â”‚ - User has permission?â­â”‚
                 â”‚    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                 â”‚      YES              NO
                 â”‚       â”‚                 â”‚
                 â”‚       â–¼                 â–¼
                 â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   â”‚ Object Level â”‚ â”‚ 403 Err â”‚
                 â”‚   â”‚ Check:       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚   â”‚ - Not paid?  â”‚
                 â”‚   â”‚ - Not cancel?â”‚
                 â”‚   â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                 â”‚     OK    FAIL
                 â”‚      â”‚      â”‚
                 â”‚      â”‚      â–¼
                 â”‚      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚      â”‚   â”‚ 403 Err  â”‚
                 â”‚      â”‚   â”‚ "Cannot  â”‚
                 â”‚      â”‚   â”‚ modify   â”‚
                 â”‚      â”‚   â”‚ paid ch."â”‚
                 â”‚      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚      â”‚
                 â””â”€â”€â”¬â”€â”€â”€â”˜
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ChalanFeeUpdate  â”‚
            â”‚ Serializer       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Update Database  â”‚
            â”‚ Update History   â”‚
            â”‚ Log Event        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ 200 OK Response  â”‚
            â”‚ Updated Chalan   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Permission Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            PERMISSION LEVELS             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Level 1: AUTHENTICATION
â”œâ”€ Must be logged in
â”œâ”€ Must have valid token
â””â”€ Anonymous users: 401 Unauthorized

        â”‚
        â–¼

Level 2: VIEW PERMISSION (CanViewChalan)
â”œâ”€ User must have chalan_view feature
â”œâ”€ Admin/staff always pass
â””â”€ Others: 403 Forbidden

        â”‚
        â–¼

Level 3: ACTION PERMISSION
â”œâ”€ CanCreateChalan (for POST)
â”‚  â””â”€ Must have chalan_create
â”œâ”€ CanEditChalan (for PATCH)
â”‚  â””â”€ Must have chalan_edit
â”œâ”€ CanMarkChalanAsPaid (for mark_as_paid)
â”‚  â””â”€ Must have chalan_mark_paid
â”œâ”€ CanManageChalanFees (for fees update) â­
â”‚  â””â”€ Must have chalan_manage_fees
â””â”€ CanCancelChalan (for cancel)
   â””â”€ Must have chalan_cancel

        â”‚
        â–¼

Level 4: OBJECT PERMISSION
â”œâ”€ Check chalan status
â”œâ”€ CanEditChalan: NOT paid
â”œâ”€ CanManageChalanFees: NOT paid, NOT cancelled
â”œâ”€ CanCancelChalan: NOT paid
â””â”€ History: No modifications allowed

        â”‚
        â–¼

âœ… Allowed or âŒ Denied
```

---

## ğŸ“± API Endpoint Flow Chart

```
/api/chalans/
â”œâ”€â”€ GET (List)              â†’ CanViewChalan âœ“
â”œâ”€â”€ POST (Create)           â†’ CanCreateChalan âœ“
â”‚
â””â”€â”€ /api/chalans/{id}/
    â”œâ”€â”€ GET (Retrieve)      â†’ CanViewChalan âœ“
    â”œâ”€â”€ PATCH (Update)      â†’ CanEditChalan âœ“
    â”œâ”€â”€ DELETE              â†’ IsAdminUser âœ“
    â”‚
    â”œâ”€â”€ POST (mark_as_paid) â†’ CanMarkChalanAsPaid âœ“
    â”‚   Payload: {payment_amount, payment_reference}
    â”‚   Response: Updated chalan with history
    â”‚
    â”œâ”€â”€ PATCH (update_fees) â†’ CanManageChalanFees â­
    â”‚   Payload: {fees_amount}
    â”‚   Response: Updated chalan with history
    â”‚
    â”œâ”€â”€ POST (cancel)       â†’ CanCancelChalan âœ“
    â”‚   Payload: {reason}
    â”‚   Response: Updated chalan with status=cancelled
    â”‚
    â”œâ”€â”€ GET (history)       â†’ CanViewChalan âœ“
    â”‚   Response: [ChalanHistory objects]
    â”‚
    â””â”€â”€ GET (statistics)    â†’ CanViewChalan âœ“
        Response: {total, by_status, fees, paid, pending}
```

---

## ğŸ—„ï¸ Database Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA MODEL                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User (Django Auth)
    â”‚
    â”œâ”€ 1â”€â”€â”€â”€â”€â”€â”€âˆ Chalan (issued_by)      [Officer who issued]
    â”‚
    â”œâ”€ 1â”€â”€â”€â”€â”€â”€â”€âˆ Chalan (user)           [Owner/Violator]
    â”‚
    â””â”€ 1â”€â”€â”€â”€â”€â”€â”€âˆ UserRole                [Permission assignment]
         â”‚
         â””â”€ âˆâ”€â”€â”€â”€â”€â”€â”€1 Role
              â”‚
              â””â”€ âˆâ”€â”€â”€â”€â”€â”€â”€âˆ Feature
                   [chalan_manage_fees] â­


Permit
    â”‚
    â””â”€ 1â”€â”€â”€â”€â”€â”€â”€âˆ Chalan                  [Associated permit]
         â”‚
         â””â”€ 1â”€â”€â”€â”€â”€â”€â”€âˆ ChalanHistory      [Change audit log]


Feature (Permissions)
    â”œâ”€ chalan_view           â† Can see chalans
    â”œâ”€ chalan_create         â† Can create
    â”œâ”€ chalan_edit           â† Can modify details
    â”œâ”€ chalan_manage_fees    â­ â† Can modify FEES
    â”œâ”€ chalan_mark_paid      â† Can record payment
    â””â”€ chalan_cancel         â† Can cancel


Chalan Fields
    â”œâ”€ Status
    â”‚  â”œâ”€ pending      â†’ just created
    â”‚  â”œâ”€ issued       â†’ officially issued
    â”‚  â”œâ”€ paid         â†’ payment received (locked)
    â”‚  â”œâ”€ cancelled    â†’ dismissed (locked)
    â”‚  â”œâ”€ disputed     â†’ owner contested
    â”‚  â””â”€ resolved     â†’ dispute resolved
    â”‚
    â”œâ”€ Financial
    â”‚  â”œâ”€ fees_amount      (editable with permission)
    â”‚  â”œâ”€ paid_amount      (updated via mark_as_paid)
    â”‚  â””â”€ remaining_amount (calculated: fees - paid)
    â”‚
    â””â”€ Audit
       â”œâ”€ created_by
       â”œâ”€ updated_by
       â”œâ”€ issued_by
       â”œâ”€ last_modified
       â””â”€ ChalanHistory (1 per action)
```

---

## ğŸ”„ Status Transition Diagram

```
Starting State: New Chalan Created
           â”‚
           â–¼
        [PENDING]
           â”‚
        â”Œâ”€â”€â”´â”€â”€â”
        â”‚     â”‚
        â–¼     â–¼
    [ISSUED] â”œâ”€â†’ Can Update
        â”‚     â”‚   Details
        â”‚  â”Œâ”€â”€â”˜   âœ“
        â”‚  â”‚   Can Mark
        â”‚  â”‚   Paid
        â”‚  â”‚   âœ“
        â”‚  â”‚   Can
        â”‚  â”‚   Cancel
        â”‚  â”‚   âœ“
        â”‚  â”‚
        â”‚  â”œâ”€â†’ [PAID] â”€â”€â”€ Terminal
        â”‚  â”‚   (Locked)
        â”‚  â”‚
        â”‚  â””â”€â†’ [CANCELLED] â”€â”€â”€ Terminal
        â”‚      (Locked)
        â”‚
        â”œâ”€â†’ [DISPUTED] â”€â†’ [RESOLVED]
        â”‚   (Under
        â”‚    review)
        â”‚
        â””â”€â†’ Any status can change to RESOLVED
```

---

## ğŸ¯ Fee Management Permission Decision Tree

```
                    User requests fee update
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Is user staff/admin?â”‚
                    â””â”€â”€â”¬â”€â”€<NO>â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                      YES         â”‚
                      â”‚â”‚          â”‚
                      â”‚â”‚   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                      â”‚â”‚   â”‚ User role   â”‚
                      â”‚â”‚   â”‚ exists?     â”‚
                      â”‚â”‚   â””â”€â”€â”¬â”€â”€<NO>â”€â”¬â”€â”€â”˜
                      â”‚â”‚     YES     â”‚
                      â”‚â”‚     â”‚â”‚      â”‚
                      â”‚â”‚  â”Œâ”€â”€â–¼â”€â”€â”    â”‚
                      â”‚â”‚  â”‚Role â”‚    â”‚
                      â”‚â”‚  â”‚active   â”‚
                      â”‚â”‚  â””â”€â”€â”¬â”€â”€<NO>â”€â”¼â”€â”€â”
                      â”‚â”‚    YES     â”‚  â”‚
                      â”‚â”‚    â”‚â”‚   â”Œâ”€â”€â–¼â”€â”€â–¼â”€â”€â”€â”
                      â”‚â”‚    â”‚â”‚   â”‚ DENIED  â”‚
                      â”‚â”‚    â”‚â”‚   â”‚ 403     â”‚
                      â”‚â”‚    â”‚â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚â”‚    â”‚â”‚
                      â”‚â”‚    â”‚â”œâ”€â†’ Check Permission
                      â”‚â”‚    â”‚    "chalan_manage_fees"
                      â”‚â”‚    â”‚        â”‚
                      â”‚â”‚    â”‚    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
                      â”‚â”‚    â”‚    â”‚    â”‚
                      â”‚â”‚   HAS  NO  â”‚
                      â”‚â”‚    â”‚    â”‚  â”‚
                      â”‚â”‚    â”‚    â”‚  â–¼
                      â”‚â”‚    â”‚    â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚â”‚    â”‚    â”‚â”‚ DENIED   â”‚
                      â”‚â”‚    â”‚    â”‚â”‚ 403 -    â”‚
                      â”‚â”‚    â”‚    â”‚â”‚ Missing  â”‚
                      â”‚â”‚    â”‚    â”‚â”‚ Permission
                      â”‚â”‚    â”‚    â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚â”‚    â”‚    â”‚
                      â”‚â”‚    â””â”€â”€â”€â”€â”¤ Check Object
                      â”‚â”‚         â”‚ Status
                      â”‚â”‚         â”‚
                      â”‚â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                      â”‚â”‚    â”‚    â”‚
                      PAID  â”‚  NOT
                      â”‚CANCELâ”‚
                      â”‚ED    â”‚
                      â”‚    â”‚
                      â–¼    â–¼
                    â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚NO â”‚          â”‚
                    â”‚   â”‚          â”‚
                    â–¼   â–¼          â–¼
                 DENIED ALLOWED  DENIED
                  403    200OK    403
```

---

## ğŸ“ˆ Data Flow Example: Create and Pay a Chalan

```
SCENARIO: Traffic officer creates chalan and marks it paid

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: POST /api/chalans/                              â”‚
â”‚ Officer creates new chalan                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Request Body:                                           â”‚
â”‚ {                                                       â”‚
â”‚   "owner_name": "Ali Ahmed",                           â”‚
â”‚   "owner_cnic": "123-1234567-1",                       â”‚
â”‚   "car_number": "ABC-123",                             â”‚
â”‚   "permit": 1,                                         â”‚
â”‚   "violation_description": "Speeding",                 â”‚
â”‚   "fees_amount": "500"                                 â”‚
â”‚ }                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Checks:                                                 â”‚
â”‚ âœ“ User authenticated                                    â”‚
â”‚ âœ“ Has chalan_create permission                          â”‚
â”‚ âœ“ Request data valid                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Actions:                                                â”‚
â”‚ 1. Generate chalan_number (CHL-20260119-12345)         â”‚
â”‚ 2. Create Chalan record in DB                          â”‚
â”‚ 3. Create ChalanHistory: action='created'              â”‚
â”‚ 4. Log Event: chalan_create                            â”‚
â”‚ 5. Set status='pending'                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Response:                                               â”‚
â”‚ {                                                       â”‚
â”‚   "id": 1,                                             â”‚
â”‚   "chalan_number": "CHL-20260119-12345",               â”‚
â”‚   "status": "pending",                                 â”‚
â”‚   "fees_amount": "500.00",                             â”‚
â”‚   "paid_amount": "0.00",                               â”‚
â”‚   ...                                                  â”‚
â”‚ }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: POST /api/chalans/1/mark_as_paid/              â”‚
â”‚ Officer receives payment and marks it                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Request Body:                                           â”‚
â”‚ {                                                       â”‚
â”‚   "payment_amount": "500.00",                          â”‚
â”‚   "payment_reference": "BANK-2026-001"                â”‚
â”‚ }                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Checks:                                                 â”‚
â”‚ âœ“ User authenticated                                    â”‚
â”‚ âœ“ Has chalan_mark_paid permission                       â”‚
â”‚ âœ“ Payment amount valid                                  â”‚
â”‚ âœ“ Chalan exists                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Actions:                                                â”‚
â”‚ 1. Update Chalan record:                               â”‚
â”‚    - status = 'paid'                                   â”‚
â”‚    - paid_amount = 500.00                              â”‚
â”‚    - payment_date = now()                              â”‚
â”‚    - payment_reference = 'BANK-2026-001'               â”‚
â”‚ 2. Create ChalanHistory: action='paid'                 â”‚
â”‚ 3. Log Event: chalan_paid                              â”‚
â”‚ 4. Record change in history                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Response:                                               â”‚
â”‚ {                                                       â”‚
â”‚   "id": 1,                                             â”‚
â”‚   "chalan_number": "CHL-20260119-12345",               â”‚
â”‚   "status": "paid",           â† Changed!               â”‚
â”‚   "fees_amount": "500.00",                             â”‚
â”‚   "paid_amount": "500.00",    â† Changed!               â”‚
â”‚   "remaining_amount": "0.00", â† Changed!               â”‚
â”‚   "payment_date": "2026-01-19T14:30:00Z",              â”‚
â”‚   ...                                                  â”‚
â”‚ }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Final State: Chalan is PAID and LOCKED
- Cannot edit status
- Cannot update fees
- But can view history showing all changes
```

---

## ğŸ›¡ï¸ Security Layers

```
                    REQUEST
                      â”‚
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ LAYER 1: AUTH        â”‚   Authentication
            â”‚ Token/Session valid? â”‚   (Is user logged in?)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ âœ“
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ LAYER 2: ENDPOINT    â”‚   Authorization
            â”‚ Right permission?    â”‚   (Is user allowed?)
            â”‚ (ViewSet level)      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ âœ“
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ LAYER 3: PERMISSION  â”‚   Feature Check
            â”‚ Has specific feature?â”‚   (chalan_manage_fees)
            â”‚ (Permission class)   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ âœ“
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ LAYER 4: OBJECT      â”‚   State Check
            â”‚ Can modify this record   (Is chalan paid?)
            â”‚ (Object permission)  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ âœ“
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ LAYER 5: SERIALIZER  â”‚   Data Validation
            â”‚ Data valid?          â”‚   (Type, format, etc.)
            â”‚ (Serializer)         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ âœ“
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ DATABASE             â”‚   Atomic Transaction
            â”‚ Save changes         â”‚   (All or nothing)
            â”‚ Log history          â”‚
            â”‚ Log event            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ âœ“
                     â–¼
            âœ… 200 OK Response
```

---

## ğŸ“Š Feature Permission Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Action              â”‚ chalan   â”‚ chalan â”‚ chalan   â”‚ chalan  â”‚ chalan   â”‚ Admin  â”‚
â”‚                     â”‚ _view    â”‚_create â”‚ _edit    â”‚_manage  â”‚ _mark_   â”‚        â”‚
â”‚                     â”‚          â”‚        â”‚          â”‚ _fees â­ â”‚ paid     â”‚        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ List chalans        â”‚    âœ“     â”‚   -    â”‚    -     â”‚    -    â”‚    -     â”‚   âœ“    â”‚
â”‚ View details        â”‚    âœ“     â”‚   -    â”‚    -     â”‚    -    â”‚    -     â”‚   âœ“    â”‚
â”‚ Create chalan       â”‚    -     â”‚   âœ“    â”‚    -     â”‚    -    â”‚    -     â”‚   âœ“    â”‚
â”‚ Edit details        â”‚    -     â”‚   -    â”‚    âœ“     â”‚    -    â”‚    -     â”‚   âœ“    â”‚
â”‚ Update fees         â”‚    -     â”‚   -    â”‚    -     â”‚    âœ“    â”‚    -     â”‚   âœ“    â”‚
â”‚ Mark as paid        â”‚    -     â”‚   -    â”‚    -     â”‚    -    â”‚    âœ“     â”‚   âœ“    â”‚
â”‚ Cancel chalan       â”‚    -     â”‚   -    â”‚    -     â”‚    -    â”‚    -     â”‚   âœ“    â”‚
â”‚ View history        â”‚    âœ“     â”‚   -    â”‚    -     â”‚    -    â”‚    -     â”‚   âœ“    â”‚
â”‚ Get statistics      â”‚    âœ“     â”‚   -    â”‚    -     â”‚    -    â”‚    -     â”‚   âœ“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
âœ“ = Allowed with feature
- = Not included in this feature
Admin = Has all permissions regardless
```

---

## ğŸ“ Understanding Chalan States

```
           CREATED
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ PENDING  â”‚  â† Initial state after creation
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚ Officer issues it officially
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ISSUED   â”‚  â† Officially issued to owner
        â””â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
          â”‚    â”‚
    Owner â”‚    â””â”€â†’ Officer disputes?
    pays  â”‚        â”‚
    â”‚     â”‚        â–¼
    â”‚     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     â”‚    â”‚ DISPUTED â”‚  â† Under review
    â”‚     â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚     â”‚         â”‚ Management resolves
    â”‚     â”‚         â”‚
    â”‚     â”‚         â–¼
    â”‚     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     â””â”€â”€â”€â†’â”‚ RESOLVED â”‚  â† Issue settled
    â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ OR â†â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚      â”‚
                       â”‚      â”‚ Officer discovers
                       â”‚      â”‚ duplicate/error
                       â”‚      â”‚
                       â–¼      â”‚
                  CANCELLED   â”‚
                  (No payment  â”‚
                   taken)      â”‚
                       â–²       â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”˜
    
    PAID STATE (Final, Locked):
    â””â”€â”€â†’ Status: PAID
         Cannot edit
         Cannot cancel
         Cannot modify fees
         Complete audit trail
```

---

This visual guide helps understand:
- ğŸ—ï¸ System architecture and data flow
- ğŸ” Permission and security layers
- ğŸ“± API endpoint organization
- ğŸ—„ï¸ Database relationships
- ğŸ”„ Status transitions
- ğŸ“Š Feature access matrix

**Key Takeaway:** Fee management is controlled through the `chalan_manage_fees` permission at multiple levels for maximum security and auditability.
