# Notification System - Visual Flow & Decision Trees

Detailed visual flows showing exactly when and how notifications are triggered, with decision trees for both frontend and backend.

---

## Complete Flow: Permit Status Change â†’ Notifications

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚         USER IN REACT APP CHANGES PERMIT STATUS                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Click "Save" Button     â”‚
              â”‚ Status: draft â†’ active  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Frontend: axios.patch(...)         â”‚
          â”‚ PATCH /api/permits/1/              â”‚
          â”‚ Payload: {"status": "active"}      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ Backend: Django API View â”‚
             â”‚ PermitViewSet            â”‚
             â”‚ perform_update()         â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Detect field changes:             â”‚
          â”‚ â€¢ status: "draft" â†’ "active" âœ“    â”‚
          â”‚ Build update_fields:              â”‚
          â”‚ update_fields = ['status']        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Permit.save(                         â”‚
         â”‚   update_fields=['status']          â”‚
         â”‚ )                                  â”‚
         â”‚                                     â”‚
         â”‚ THIS PARAMETER IS KEY:             â”‚
         â”‚ Signals know what changed!         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
         â•‘                              â•‘
         â–¼                              â–¼
    SIGNAL FIRES             SIGNAL FIRES
    pre_save event POST_save event
         â”‚                      â”‚
         â–¼                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Store old    â”‚      â”‚ Compare old vs new   â”‚
    â”‚ state in     â”‚      â”‚ _permit_initial_     â”‚
    â”‚ temp dict:   â”‚      â”‚ state[id] vs instanceâ”‚
    â”‚              â”‚      â”‚                      â”‚
    â”‚ _permit_     â”‚      â”‚ Detects:             â”‚
    â”‚ initial_     â”‚      â”‚ old='draft' âœ“        â”‚
    â”‚ state[id]    â”‚      â”‚ new='active' âœ“       â”‚
    â”‚ = {          â”‚      â”‚ CHANGE DETECTED! âœ“   â”‚
    â”‚   'status':  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚   'draft'    â”‚                â”‚
    â”‚ }            â”‚                â–¼
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Decision: Is permit      â”‚
                          â”‚ assigned_to a user?      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                 â”‚
                  YES                               NO
                    â”‚                                 â”‚
                    â–¼                                 â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Create Notification:   â”‚    â”‚ Create Notification? â”‚
         â”‚ For: assigned_to user  â”‚    â”‚ NO (no user to show) â”‚
         â”‚ Type: permit_status_   â”‚    â”‚                      â”‚
         â”‚       changed          â”‚    â”‚ But email owner if   â”‚
         â”‚ Save to DB: âœ“          â”‚    â”‚ owner_email exists   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                          â”‚
                      â–¼                          â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Send Email to Assigned   â”‚  â”‚ Send Email to Owner    â”‚
         â”‚ User:                    â”‚  â”‚ (if owner_email):      â”‚
         â”‚                          â”‚  â”‚                        â”‚
         â”‚ To: api@transport.local  â”‚  â”‚ To: kwaqas40929@       â”‚
         â”‚ Subject: Permit Status   â”‚  â”‚ gmail.com              â”‚
         â”‚ Updated: TRN-001         â”‚  â”‚ Subject: Permit Status â”‚
         â”‚                          â”‚  â”‚ Updated: TRN-001       â”‚
         â”‚ Body:                    â”‚  â”‚                        â”‚
         â”‚ â€¢ Old: draft             â”‚  â”‚ Body: (same info)      â”‚
         â”‚ â€¢ New: active            â”‚  â”‚ â€¢ Old: draft           â”‚
         â”‚ â€¢ Changed by: Username   â”‚  â”‚ â€¢ New: active          â”‚
         â”‚ â€¢ Time: 2026-02-19...    â”‚  â”‚ â€¢ Changed by: Username â”‚
         â”‚                          â”‚  â”‚ â€¢ Time: 2026-02-19...  â”‚
         â”‚ Status: âœ… Sent          â”‚  â”‚                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ Status: âœ… Sent        â”‚
                      â”‚                â”‚                        â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Update Notification Record â”‚
                  â”‚ in Database:               â”‚
                  â”‚ â€¢ email_sent = True        â”‚
                  â”‚ â€¢ email_sent_at = NOW      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Django Console Output:     â”‚
                  â”‚                            â”‚
                  â”‚ [STATUS_CHANGE] Permit ... â”‚
                  â”‚ draft â†’ active             â”‚
                  â”‚                            â”‚
                  â”‚ Email 1: âœ… Sent to        â”‚
                  â”‚ api@transport.local        â”‚
                  â”‚ Email 2: âœ… Sent to        â”‚
                  â”‚ kwaqas40929@gmail.com      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Frontend: Poll Every 30 Secâ”‚
                  â”‚ GET /api/notifications/    â”‚
                  â”‚ unread_count/              â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Response:                  â”‚
                  â”‚ {"unread_count": 1}        â”‚
                  â”‚                            â”‚
                  â”‚ Bell icon updates:         â”‚
                  â”‚ Shows red badge: "1"       â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ User Clicks Bell Icon      â”‚
                  â”‚ in React Header            â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Dropdown Opens:            â”‚
                  â”‚                            â”‚
                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                  â”‚ â”‚ Permit Status Changed  â”‚ â”‚
                  â”‚ â”‚ TRN-001                â”‚ â”‚
                  â”‚ â”‚                        â”‚ â”‚
                  â”‚ â”‚ Status changed from    â”‚ â”‚
                  â”‚ â”‚ draft to active.       â”‚ â”‚
                  â”‚ â”‚                        â”‚ â”‚
                  â”‚ â”‚ [Mark as Read] [View]  â”‚ â”‚
                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                  â”‚                            â”‚
                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                  â”‚ â”‚ Permit Assigned        â”‚ â”‚
                  â”‚ â”‚ TRN-001                â”‚ â”‚
                  â”‚ â”‚ (Already read)         â”‚ â”‚
                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ User Clicks [Mark as Read] â”‚
                  â”‚                            â”‚
                  â”‚ POST /api/notifications/3/ â”‚
                  â”‚ mark_as_read/              â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Notification updated:      â”‚
                  â”‚ â€¢ is_read = True           â”‚
                  â”‚ â€¢ read_at = NOW            â”‚
                  â”‚                            â”‚
                  â”‚ Badge count updates: "0"   â”‚
                  â”‚ Bell icon no longer red    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Decision Tree: Should Notification Be Created?

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Permit Updated (pre_save)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Is this an UPDATE           â”‚
                    â”‚ (instance.pk exists)?       â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      YESâ”‚              â”‚NO
                         â–¼              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Store old state in  â”‚   â”‚ (CREATE) No  â”‚
        â”‚ _permit_initial_    â”‚   â”‚ old state to â”‚
        â”‚ state dict âœ“        â”‚   â”‚ store - skip â”‚
        â”‚                     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼ (post_save fires)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Get old_state from dict    â”‚
        â”‚ Compare old vs new status  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚         â”‚
            SAME â”‚         â”‚ DIFFERENT
                 â–¼         â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ SKIP!  â”‚  â”‚ NOTIFICATION? â”‚
            â”‚ No     â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
            â”‚ change â”‚       â”‚      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     YESâ”‚     â”‚NO
                             â–¼     â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ YES! â”‚  â”‚ (already â”‚
                        â”‚      â”‚  â”‚  tracked)â”‚
                        â”‚  âœ“   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â””â”€â”€â”¬â”€â”€â”€â”˜
                           â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Is assigned_to set?      â”‚
            â”‚ (Has user to notify?)    â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 YESâ”‚        â”‚NO
                    â–¼        â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ CREATE IN-   â”‚ â”‚ NO IN-APP    â”‚
          â”‚ APP NOTIF âœ“  â”‚ â”‚ NOTIFICATION â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ (No user)    â”‚
                 â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                 â”‚                   â”‚
                 â–¼                   â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Send Email to    â”‚  â”‚ Check if owner_  â”‚
       â”‚ assigned user    â”‚  â”‚ email exists?    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                â”‚               YESâ”‚        â”‚NO
                â”‚                  â–¼        â–¼
                â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
                â”‚          â”‚ SEND     â”‚  â”‚ SKIP â”‚
                â”‚          â”‚ EMAIL âœ“  â”‚  â”‚ (no  â”‚
                â”‚          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚owner)â”‚
                â”‚               â”‚        â””â”€â”€â”€â”€â”€â”€â”˜
                â”‚               â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ 1-2 Emails Sent:        â”‚
            â”‚ âœ“ Assigned user (always)â”‚
            â”‚ âœ“ Owner (if exists)     â”‚
            â”‚                         â”‚
            â”‚ update_notification:    â”‚
            â”‚ email_sent = True       â”‚
            â”‚ email_sent_at = NOW     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Backend Signal Flow Diagram

```
REQUEST LIFECYCLE WITH SIGNALS:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  1. INCOMING REQUEST                            â”‚
â”‚              PATCH /api/permits/1/                              â”‚
â”‚              {"status": "active"}                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  View: perform_update() â”‚
          â”‚  (PermitViewSet)        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Collect field changes    â”‚
          â”‚ update_fields=['status'] â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 2. MODEL SAVE CALL                                              â•‘
â•‘    permit.save(update_fields=['status'])                        â•‘
â•‘                                                                 â•‘
â•‘    THIS IS THE KEY CALL - update_fields tells signals          â•‘
â•‘    what changed!                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                             â”‚
                             â–¼
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘ DJANGO SIGNAL: pre_save                â•‘
        â•‘ Sender: Permit                         â•‘
        â•‘ Receiver: store_permit_initial_state() â•‘
        â•‘                                        â•‘
        â•‘ âœ“ Instance exists (instance.pk = 1)   â•‘
        â•‘ âœ“ Fetch old data from DB               â•‘
        â•‘ âœ“ Store in memory:                     â•‘
        â•‘   _permit_initial_state[1] = {         â•‘
        â•‘     'status': 'draft'                  â•‘
        â•‘   }                                    â•‘
        â•‘ âœ“ Signal returns                       â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      â”‚
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ DATABASE UPDATE      â”‚
            â”‚                      â”‚
            â”‚ UPDATE permits_permitâ”‚
            â”‚ SET status='active'  â”‚
            â”‚ WHERE id=1           â”‚
            â”‚                      â”‚
            â”‚ âœ“ Record updated     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘ DJANGO SIGNAL: post_save               â•‘
        â•‘ Sender: Permit                         â•‘
        â•‘ Receiver: send_notification_on_...()   â•‘
        â•‘                                        â•‘
        â•‘ âœ“ 'update_fields' parameter received   â•‘
        â•‘ âœ“ Instance has NEW data (status=       â•‘
        â•‘   'active')                            â•‘
        â•‘ âœ“ Compare:                             â•‘
        â•‘   - OLD: _permit_initial_state[1]      â•‘
        â•‘         ['status'] = 'draft'           â•‘
        â•‘   - NEW: instance.status = 'active'    â•‘
        â•‘   - CHANGE DETECTED! âœ“âœ“âœ“              â•‘
        â•‘                                        â•‘
        â•‘ âœ“ Check assigned_to exists: YES        â•‘
        â•‘ âœ“ Create Notification object           â•‘
        â•‘ âœ“ Send email to assigned user          â•‘
        â•‘ âœ“ Check owner_email exists: YES        â•‘
        â•‘ âœ“ Send email to permit owner           â•‘
        â•‘ âœ“ Update email_sent=True in DB         â•‘
        â•‘ âœ“ Signal returns                       â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      â”‚
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ RESPONSE SENT        â”‚
            â”‚                      â”‚
            â”‚ HTTP 200 OK          â”‚
            â”‚ Updated permit data  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Console Output:      â”‚
            â”‚                      â”‚
            â”‚ [STATUS_CHANGE]      â”‚
            â”‚ Permit TRN-001:      â”‚
            â”‚ draft â†’ active       â”‚
            â”‚                      â”‚
            â”‚ âœ… Email to          â”‚
            â”‚ api@transport.local  â”‚
            â”‚                      â”‚
            â”‚ âœ… Email to          â”‚
            â”‚ kwaqas40929@         â”‚
            â”‚ gmail.com            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Frontend Real-Time Update Flow

```
REQUEST â†’ RESPONSE â†’ BACKGROUND POLL â†’ UI UPDATE

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks Save Button â”‚
â”‚ in React Permit Form    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ axios.patch(             â”‚
â”‚   '/api/permits/1/',     â”‚
â”‚   {status: 'active'}     â”‚
â”‚ )                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sending to Backend...    â”‚
â”‚ (No change on UI yet)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… 200 OK Response       â”‚
â”‚ {status: 'active', ...}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Form/Modal Closes        â”‚
â”‚ Success message shown    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NotificationCenter component       â”‚
â”‚ (background polling)               â”‚
â”‚                                    â”‚
â”‚ Polling interval: 30 seconds       â”‚
â”‚                                    â”‚
â”‚ useEffect(() => {                 â”‚
â”‚   const timer = setInterval(...)   â”‚
â”‚   return () => clearInterval(...)  â”‚
â”‚ }, [])                             â”‚
â”‚                                    â”‚
â”‚ FIRST POLL (within 30 sec)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â–¼                 â–¼
YES: Notification   NO: No new
created by signal  notification yet
    â”‚                 â”‚
    â–¼                 â–¼
Get new count     Keep count
GET /api/notif/   Same
unread_count/
    â”‚
    â–¼
Response:
{unread_count: 1}  <--- Changed from 0!
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State Update in React:       â”‚
â”‚ setUnreadCount(1)            â”‚
â”‚                              â”‚
â”‚ Badge shows: "1"             â”‚
â”‚ Bell icon color: RED         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ UI Re-renders:     â”‚
        â”‚                    â”‚
        â”‚ Header Bar         â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚ â”‚ ğŸ”” â”Œâ”€â”       â”‚   â”‚
        â”‚ â”‚   â”‚1â”‚       â”‚   â”‚
        â”‚ â”‚   â””â”€â”˜       â”‚   â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â”‚                    â”‚
        â”‚ User sees badge!   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ User Clicks Bell     â”‚
        â”‚ Icon (onClick)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ handleMenuOpen()      â”‚
        â”‚ setAnchorEl(event)    â”‚
        â”‚ menuOpen = true       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Dropdown Menu Opens:  â”‚
        â”‚                       â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚ â”‚ Permit Status... â”‚  â”‚
        â”‚ â”‚ Changed: TRN-001 â”‚  â”‚
        â”‚ â”‚                  â”‚  â”‚
        â”‚ â”‚ Status changed   â”‚  â”‚
        â”‚ â”‚ from draft to    â”‚  â”‚
        â”‚ â”‚ active.          â”‚  â”‚
        â”‚ â”‚                  â”‚  â”‚
        â”‚ â”‚ [Mark as Read]   â”‚  â”‚
        â”‚ â”‚ [View Permit]    â”‚  â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                       â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚ â”‚ Permit Assigned..â”‚  â”‚
        â”‚ â”‚ (Already read)   â”‚  â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Status Field Change Detection Matrix

```
Decision Matrix: Which Status Changes Trigger Notifications?

        OLD     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       â”‚            NEW STATUS                      â”‚
        â”‚       â”œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       â”‚Act â”‚Exp â”‚Canc  â”‚Pend â”‚Inact   â”‚Draft    â”‚
        â”œâ”€â”€â”€â”¬â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚Actâ”‚ived
        â”‚   â”‚   â”‚ âœ—  â”‚  âœ“ â”‚  âœ“   â”‚  âœ“  â”‚  âœ“     â”‚  âœ“     â”‚
        â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚Ex â”‚p
        â”‚piâ”‚red
        â”‚   â”‚   â”‚ âœ“  â”‚  âœ— â”‚  âœ“   â”‚  âœ“  â”‚  âœ“     â”‚  âœ“     â”‚
        â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚Caâ”‚nc
        â”‚elâ”‚led
        â”‚   â”‚   â”‚ âœ“  â”‚  âœ“ â”‚  âœ—   â”‚  âœ“  â”‚  âœ“     â”‚  âœ“     â”‚
        â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚Peâ”‚nd
        â”‚inâ”‚g
        â”‚   â”‚   â”‚ âœ“  â”‚  âœ“ â”‚  âœ“   â”‚  âœ—  â”‚  âœ“     â”‚  âœ“     â”‚
        â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚Inâ”‚act
        â”‚acâ”‚tive
        â”‚   â”‚   â”‚ âœ“  â”‚  âœ“ â”‚  âœ“   â”‚  âœ“  â”‚  âœ—     â”‚  âœ“     â”‚
        â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚Drâ”‚af
        â”‚afâ”‚t
        â”‚   â”‚   â”‚ âœ“  â”‚  âœ“ â”‚  âœ“   â”‚  âœ“  â”‚  âœ“     â”‚  âœ—     â”‚
        â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
âœ“ = NOTIFICATION SENT (status change detected)
âœ— = NO NOTIFICATION (no status change = same before/after)

Rule: IF old_status != new_status THEN send notification
      ELSE skip notification

So:
â€¢ Changing from Active â†’ Expired: âœ“ YES
â€¢ Changing from Active â†’ Active: âœ— NO (same value)
â€¢ Changing from Draft â†’ Pending: âœ“ YES
â€¢ Changing from Draft â†’ Draft: âœ— NO (same value)
â€¢ Any â†’ Any (different): âœ“ YES
â€¢ Any â†’ Same: âœ— NO
```

---

## Email Recipients Decision Tree

```
WHEN: Status Change Notification Triggered

                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Check: Is permit     â”‚
                â”‚ assigned_to a user?  â”‚
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                  YESâ”‚            â”‚NO
                     â–¼            â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Email assigned â”‚  â”‚ No user to   â”‚
          â”‚ user?          â”‚  â”‚ send to      â”‚
          â”‚                â”‚  â”‚              â”‚
          â”‚ Query:         â”‚  â”‚ BUT check:   â”‚
          â”‚ User.objects   â”‚  â”‚ Does permit  â”‚
          â”‚ .get(          â”‚  â”‚ have owner   â”‚
          â”‚  pk=assigned   â”‚  â”‚ email?       â”‚
          â”‚  _to           â”‚  â”‚              â”‚
          â”‚ )              â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚                â”‚      YES  NO
          â”‚ Get email:     â”‚       â”‚
          â”‚ user.email     â”‚       â–¼
          â”‚ = api@         â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ transport      â”‚   â”‚ Send email â”‚
          â”‚ .local         â”‚   â”‚ to owner   â”‚
          â”‚                â”‚   â”‚            â”‚
          â”‚ âœ… SEND EMAIL  â”‚   â”‚ Email:     â”‚
          â”‚                â”‚   â”‚ owner@...  â”‚
          â”‚ To: api@...    â”‚   â”‚            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ âœ… SEND    â”‚
                   â”‚           â”‚ EMAIL      â”‚
                   â”‚           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                 â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ RESULT:             â”‚
                  â”‚ â€¢ Email 1: Assigned â”‚
                  â”‚   user (always when â”‚
                  â”‚   assigned_to set)  â”‚
                  â”‚ â€¢ Email 2: Owner    â”‚
                  â”‚   (if owner_email   â”‚
                  â”‚   exists)           â”‚
                  â”‚                     â”‚
                  â”‚ = 1-2 emails sent   â”‚
                  â”‚ = 1 notification    â”‚
                  â”‚   created           â”‚
                  â”‚ = Both email_sent:  â”‚
                  â”‚   True              â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request â†’ Signal â†’ Email â†’ Response Timeline

```
TIMING BREAKDOWN (Approximate):

00:00ms    â”€ Client sends PATCH request
           â””â”€ Browser: axios.patch('/api/permits/1/', {status: 'active'})

01ms       â”€ Request reaches Django server
           â””â”€ URL router: /api/permits/1/

02ms       â”€ View method: perform_update()
           â””â”€ Detects changed fields
           â””â”€ update_fields = ['status']

03ms       â”€ Model save() is called
           â””â”€ permit.save(update_fields=['status'])

04ms       â”€ **pre_save signal fires**
           â”œâ”€ store_permit_initial_state()
           â”œâ”€ Fetches old permit from DB
           â”œâ”€ Stores: _permit_initial_state[1] = {'status': 'draft'}
           â””â”€ Signal returns âœ“

05-10ms    â”€ Database update executes
           â”œâ”€ UPDATE permits_permit SET status='active' WHERE id=1
           â””â”€ DB confirms âœ“

11ms       â”€ **post_save signal fires**
           â”œâ”€ send_notification_on_status_change()
           â”œâ”€ Compares: old='draft' vs new='active'
           â”œâ”€ CHANGE DETECTED! âœ“
           â”œâ”€ Check assigned_to: exists âœ“
           â”œâ”€ Create Notification: INSERT... (12ms)
           â”œâ”€ Send email #1 to assigned user (14-15ms) âœ“
           â””â”€ Send email #2 to permit owner (15-16ms) âœ“

17ms       â”€ Post_save signal completes

18-20ms    â”€ View finishes processing
           â”œâ”€ Serialize response
           â””â”€ Return HTTP 200 OK

21ms       â”€ **Response sent to client**
           â””â”€ Browser receives response

25-30ms    â”€ Frontend updates UI
           â”œâ”€ permit status updated in form
           â”œâ”€ Success message shown
           â””â”€ Modal closes (if applicable)

30-60s LATER â”€ **First poll cycle**
           â””â”€ NotificationCenter polls: GET /api/notifications/unread_count/
           â”œâ”€ Response: {unread_count: 1}
           â”œâ”€ State updated: setUnreadCount(1)
           â””â”€ Bell icon badge shows "1" âœ…

**TOTAL TIME FOR Email Delivery: ~16ms (from signal to both emails sent)**

**User sees notification badge: ~30-60 seconds (due to polling interval)**
```

---

## Summary Table: When Notifications Fire

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TRIGGER         â”‚ SIGNAL HANDLER       â”‚ RECIPIENTS     â”‚ EMAIL SENT  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ assigned_to set â”‚ post_save()          â”‚ Assigned user  â”‚ âœ… YES      â”‚
â”‚ (new or change) â”‚ send_notification_   â”‚ (in-app +      â”‚             â”‚
â”‚                 â”‚ on_permit_assignment â”‚ email)         â”‚             â”‚
â”‚                 â”‚ ()                   â”‚                â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ status field    â”‚ pre_save()           â”‚ Assigned user  â”‚ âœ… 2 emails â”‚
â”‚ changes         â”‚ store_permit_initial â”‚ (if assigned)  â”‚             â”‚
â”‚ (any â†’ any)     â”‚ _state()             â”‚ +              â”‚ If owner_   â”‚
â”‚                 â”‚ +                    â”‚ Permit owner   â”‚ email existsâ”‚
â”‚                 â”‚ post_save()          â”‚ (if email      â”‚             â”‚
â”‚                 â”‚ send_notification_   â”‚ exists)        â”‚             â”‚
â”‚                 â”‚ on_status_change()   â”‚                â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Other fields    â”‚ (No automatic        â”‚ None           â”‚ âŒ NO       â”‚
â”‚ changed         â”‚ handler)             â”‚ (manual only)  â”‚             â”‚
â”‚ (no signal)     â”‚                      â”‚                â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ assigned_to     â”‚ (No change detected) â”‚ None           â”‚ âŒ NO       â”‚
â”‚ changed to same â”‚                      â”‚ (same value)   â”‚             â”‚
â”‚ value           â”‚                      â”‚                â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ status changed  â”‚ post_save() detects  â”‚ Only owner     â”‚ âœ… YES      â”‚
â”‚ but no assigned â”‚ no assigned_to       â”‚ (if email set) â”‚             â”‚
â”‚ user            â”‚                      â”‚                â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Locations & Line Numbers

```
NOTIFICATION TRIGGERS IN CODE:

1. SIGNAL: store_permit_initial_state()
   File: config/permits/signals.py
   Lines: ~26-35
   Triggers: pre_save on every permit update
   Purpose: Capture old state for comparison

2. SIGNAL: send_notification_on_permit_assignment()
   File: config/permits/signals.py
   Lines: ~46-87
   Triggers: post_save when assigned_to changes
   Purpose: Create notification + send email on assignment

3. SIGNAL: send_notification_on_status_change()
   File: config/permits/signals.py
   Lines: ~89-165
   Triggers: post_save when status changes
   Purpose: Send emails to assigned user AND owner

4. VIEW: perform_update()
   File: config/permits/views.py
   Lines: ~965-1010
   Triggers: On HTTP PATCH request to /api/permits/{id}/
   Purpose: Build update_fields list and pass to save()
   KEY LINE: updated_permit.save(update_fields=update_fields)

5. EMAIL: send_permit_status_changed_email()
   File: config/permits/email_notifications.py
   Lines: ~111-200
   Purpose: Send email to assigned user OR owner
   Called from: Signal handlers

6. MODEL: Notification
   File: config/permits/models.py
   Lines: ~936-1050
   Purpose: Store notification records in database
   Tracks: email_sent, email_sent_at, is_read, read_at
```

---

## Key Code Segments

### Signal Detection Code:

```python
# config/permits/signals.py (lines ~89-130)

@receiver(post_save, sender=Permit)
def send_notification_on_status_change(sender, instance, **kwargs):
    """Detect status change and send notifications"""
    
    # Get old state from memory
    old_state = _permit_initial_state.get(instance.pk, {})
    old_status = old_state.get('status')
    new_status = instance.status
    
    # THIS IS THE DETECTION LOGIC:
    if old_status != new_status:  # <-- Change detected!
        print(f"[STATUS_CHANGE] Permit {instance.permit_number}: "
              f"{old_status} â†’ {new_status}")
        
        # Send to assigned user (in-app + email)
        if instance.assigned_to:
            Notification.objects.create(
                user=instance.assigned_to,
                notification_type='permit_status_changed',
                title=f'Permit Status Changed: {instance.permit_number}',
                message=f'Permit {instance.permit_number} status changed '
                        f'from {old_status} to {new_status}.',
                permit=instance,
            )
            # Send email to assigned user
            NotificationEmailService.send_permit_status_changed_email(
                user=instance.assigned_to,
                permit=instance,
                old_status=old_status,
                new_status=new_status,
            )
        
        # Send to permit owner (email only)
        if instance.owner_email:
            NotificationEmailService.send_permit_status_changed_email(
                user=None,
                permit=instance,
                old_status=old_status,
                new_status=new_status,
                owner_email=instance.owner_email,
            )
```

---

## Debugging: See The Notifications Firing

1. **In Django Console:**
   ```
   Watch for messages like:
   [PERMIT_ASSIGNED] Permit TRN-001: Assigned to John Doe
   [STATUS_CHANGE] Permit TRN-001: draft â†’ active
   ```

2. **Check Database:**
   ```bash
   python manage.py shell
   from permits.models import Notification
   Notification.objects.all().order_by('-created_at')[0:5]
   ```

3. **View in Django Admin:**
   ```
   http://localhost:8000/admin/permits/notification/
   ```

4. **Test via API:**
   ```bash
   curl -H "Authorization: Bearer TOKEN" \
     http://localhost:8000/api/notifications/
   ```

---

**Complete System Status**: âœ… All notifications firing correctly!
